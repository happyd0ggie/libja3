/*
 * Copyright (c) 2021 Jan Gru
 * Based on https://www.ccs.neu.edu/home/skotthe/classes/cs5600/fall/2015/labs/intro-check.html
 * 
 * All rights reserved.
 * BSD 3-Clause License
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice, this
 *    list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * 3. Neither the name of the copyright holder nor the names of its
 *    contributors may be used to endorse or promote products derived from
 *    this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
 * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 */

#include <check.h>
#include <stdlib.h>
#include "../src/ja3.h"

START_TEST(test_get_ja3_client_hello_seg_1)
{
    const char *EXP_JA3STR = \
    "771,4866-4867-4865-49196-49200-159-52393-52392-52394-49195-49199-158-49188"
    "-49192-107-49187-49191-103-49162-49172-57-49161-49171-51-157-156-61-60-53-"
    "47-255,0-11-10-13172-16-22-23-13-43-45-51-21,29-23-30-25-24,0-1-2";
    const char *EXP_JA3HEXSTR = "456523fc94726331a4d5a2e1d40b2cd7";
    const uint PL_LEN = 517;

    const u_char payload[517] = \
    "\x16\x03\x01\x02\x00\x01\x00\x01\xfc\x03\x03\x94\xe4\xd7\x3f\xbb"
    "\x5a\x90\xcc\x1f\x75\xd9\xc3\x83\x00\x0b\xf3\xd6\x97\x4e\x84\xae"
    "\xad\xad\xec\x18\x10\x49\xb9\xce\x61\xf3\xc3\x20\x21\x37\x43\xc0"
    "\xea\x08\xfe\x72\x7e\x1e\x62\x9c\x2c\x6f\xc3\x60\x52\x8d\x38\x7e"
    "\x22\xdf\x09\x5e\x5d\x72\x7c\x09\xce\x88\x34\x8c\x00\x3e\x13\x02"
    "\x13\x03\x13\x01\xc0\x2c\xc0\x30\x00\x9f\xcc\xa9\xcc\xa8\xcc\xaa"
    "\xc0\x2b\xc0\x2f\x00\x9e\xc0\x24\xc0\x28\x00\x6b\xc0\x23\xc0\x27"
    "\x00\x67\xc0\x0a\xc0\x14\x00\x39\xc0\x09\xc0\x13\x00\x33\x00\x9d"
    "\x00\x9c\x00\x3d\x00\x3c\x00\x35\x00\x2f\x00\xff\x01\x00\x01\x75"
    "\x00\x00\x00\x17\x00\x15\x00\x00\x12\x66\x72\x6f\x6e\x74\x65\x64"
    "\x2e\x64\x69\x67\x69\x2e\x6e\x69\x6e\x6a\x61\x00\x0b\x00\x04\x03"
    "\x00\x01\x02\x00\x0a\x00\x0c\x00\x0a\x00\x1d\x00\x17\x00\x1e\x00"
    "\x19\x00\x18\x33\x74\x00\x00\x00\x10\x00\x0e\x00\x0c\x02\x68\x32"
    "\x08\x68\x74\x74\x70\x2f\x31\x2e\x31\x00\x16\x00\x00\x00\x17\x00"
    "\x00\x00\x0d\x00\x30\x00\x2e\x04\x03\x05\x03\x06\x03\x08\x07\x08"
    "\x08\x08\x09\x08\x0a\x08\x0b\x08\x04\x08\x05\x08\x06\x04\x01\x05"
    "\x01\x06\x01\x03\x03\x02\x03\x03\x01\x02\x01\x03\x02\x02\x02\x04"
    "\x02\x05\x02\x06\x02\x00\x2b\x00\x09\x08\x03\x04\x03\x03\x03\x02"
    "\x03\x01\x00\x2d\x00\x02\x01\x01\x00\x33\x00\x26\x00\x24\x00\x1d"
    "\x00\x20\x32\xa2\x06\x8f\xea\x13\x10\x0d\xdb\x28\xdd\xad\x87\x75"
    "\xf2\x3b\xc5\xb0\xea\x20\xe0\x2e\xea\xed\xb0\x34\x43\xf4\x74\x1a"
    "\x68\x3e\x00\x15\x00\xaf\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00";

    struct ja3_struct *ja3; 
    int ret = get_ja3_struct_from_segment(payload, PL_LEN, &ja3);
    ck_assert_int_eq(ret, 0);
    ck_assert_str_eq(ja3->ja3str, EXP_JA3STR);
    ck_assert_str_eq(ja3->ja3hexstr, EXP_JA3HEXSTR);
    
    /* Clean up */
    free_ja3_struct(ja3);
}
END_TEST


START_TEST(test_get_ja3_client_hello_seg_2)
{
    const char *EXP_JA3STR = \
    "771,4866-4867-4865-49196-49200-159-52393-52392-52394-49195-49199-" 
    "158-49188-49192-107-49187-49191-103-49162-49172-57-49161-49171-51-" 
    "157-156-61-60-53-47-255,0-11-10-13172-16-22-23-13-43-45-51-21,29-23" 
    "-30-25-24,0-1-2";
    const char * EXP_JA3HEXSTR = "456523fc94726331a4d5a2e1d40b2cd7";
    const uint PL_LEN = 517;

    const u_char payload[517] = \
    "\x16\x03\x01\x02\x00\x01\x00\x01\xfc\x03\x03\xf6\x65\x0b\x22\x13" \
    "\xf1\xc3\xe9\xe7\xb3\xdc\x09\xe4\x4b\xcb\x6e\x05\xaf\x8f\x2f\x41" \
    "\x8d\x15\xa8\x88\x46\x24\x83\xca\x09\x7c\x95\x20\x12\xc4\x5e\x71" \
    "\x8b\xb9\xc9\xa9\x37\x93\x4c\x41\xa6\xe8\x9e\x8f\x15\x78\x52\x0e" \
    "\x3c\x28\xba\xab\xa3\x34\x8b\x53\x82\x83\x75\x24\x00\x3e\x13\x02" \
    "\x13\x03\x13\x01\xc0\x2c\xc0\x30\x00\x9f\xcc\xa9\xcc\xa8\xcc\xaa" \
    "\xc0\x2b\xc0\x2f\x00\x9e\xc0\x24\xc0\x28\x00\x6b\xc0\x23\xc0\x27" \
    "\x00\x67\xc0\x0a\xc0\x14\x00\x39\xc0\x09\xc0\x13\x00\x33\x00\x9d" \
    "\x00\x9c\x00\x3d\x00\x3c\x00\x35\x00\x2f\x00\xff\x01\x00\x01\x75" \
    "\x00\x00\x00\x10\x00\x0e\x00\x00\x0b\x65\x78\x61\x6d\x70\x6c\x65" \
    "\x2e\x63\x6f\x6d\x00\x0b\x00\x04\x03\x00\x01\x02\x00\x0a\x00\x0c" \
    "\x00\x0a\x00\x1d\x00\x17\x00\x1e\x00\x19\x00\x18\x33\x74\x00\x00" \
    "\x00\x10\x00\x0e\x00\x0c\x02\x68\x32\x08\x68\x74\x74\x70\x2f\x31" \
    "\x2e\x31\x00\x16\x00\x00\x00\x17\x00\x00\x00\x0d\x00\x30\x00\x2e" \
    "\x04\x03\x05\x03\x06\x03\x08\x07\x08\x08\x08\x09\x08\x0a\x08\x0b" \
    "\x08\x04\x08\x05\x08\x06\x04\x01\x05\x01\x06\x01\x03\x03\x02\x03" \
    "\x03\x01\x02\x01\x03\x02\x02\x02\x04\x02\x05\x02\x06\x02\x00\x2b" \
    "\x00\x09\x08\x03\x04\x03\x03\x03\x02\x03\x01\x00\x2d\x00\x02\x01" \
    "\x01\x00\x33\x00\x26\x00\x24\x00\x1d\x00\x20\x37\x98\x48\x7f\x2f" \
    "\xbc\x86\xf9\xb8\x02\xcd\x31\xf0\x04\x30\xa9\x2f\x29\x61\xac\xec" \
    "\xc9\x2f\xf7\x45\xad\xd9\x67\x07\x14\x62\x01\x00\x15\x00\xb6\x00" \
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
    "\x00\x00\x00\x00\x00";

    struct ja3_struct *ja3; 
    int ret = get_ja3_struct_from_segment(payload, PL_LEN, &ja3);
    ck_assert_int_eq(ret, 0);
    ck_assert_str_eq(ja3->ja3str, EXP_JA3STR);
    ck_assert_str_eq(ja3->ja3hexstr, EXP_JA3HEXSTR);
    /* Clean up */
    free_ja3_struct(ja3);
}
END_TEST

START_TEST(test_get_ja3_server_hello_seg_1)
{
    const char *EXP_JA3STR = "771,4865,43-51";
    const char *EXP_HEXSTR = "f4febc55ea12b31ae17cfb7e614afda8";
    const uint PL_LEN = 1438;

    const u_char payload[1438] = \
    "\x16\x03\x03\x00\x7a\x02\x00\x00\x76\x03\x03\x35\x80\x84\x03\xfb" \
    "\x04\x3e\xdc\x53\x91\x75\x75\x40\x07\x6b\xa4\xed\x98\x6a\x67\x92" \
    "\x36\x39\xe9\x8b\x4d\x6c\x45\x08\x6a\x4c\x0e\x20\x21\x37\x43\xc0" \
    "\xea\x08\xfe\x72\x7e\x1e\x62\x9c\x2c\x6f\xc3\x60\x52\x8d\x38\x7e" \
    "\x22\xdf\x09\x5e\x5d\x72\x7c\x09\xce\x88\x34\x8c\x13\x01\x00\x00" \
    "\x2e\x00\x2b\x00\x02\x03\x04\x00\x33\x00\x24\x00\x1d\x00\x20\x5b" \
    "\x34\x58\x56\x96\x9f\x58\x86\xee\xca\x9c\x55\x01\xbd\x56\x90\x94" \
    "\xc9\x36\x92\xab\x10\x3d\xc5\xc7\x27\xa5\x80\x89\xca\x3f\x06\x14" \
    "\x03\x03\x00\x01\x01\x17\x03\x03\x00\x24\x0d\x0a\xb7\xa6\xf3\xac" \
    "\xa6\xff\xfb\x25\xe7\x69\xaf\xef\x22\x24\x44\x68\xc7\x06\x5f\xd9" \
    "\x3e\xe5\xbf\x7c\x22\x4a\x97\x42\x1d\x5a\xf8\xef\xdb\xbe\x17\x03" \
    "\x03\x12\xfb\x3a\x84\x09\x43\x83\x35\x5b\xdb\x12\x4c\x7f\x49\x90" \
    "\xd0\x3b\x8d\x57\x8f\x7a\xe8\xba\x85\xcc\xc4\x75\x8f\xaf\xdf\xbf" \
    "\xbd\xf4\xcc\x8c\xae\x39\xf9\x47\x31\x20\x42\x0e\xe7\xc6\xb9\xa0" \
    "\x46\xd1\x4f\x6d\x86\x69\x60\xa8\x66\xf9\xed\x3e\x65\xa5\xa7\xf7" \
    "\xd3\x8f\xfa\xfd\xc1\xa5\x14\x13\x43\x52\x49\x70\xb8\x23\x83\xaa" \
    "\x99\x12\x98\x1a\xa6\xb2\x7e\xe9\x46\x94\x92\x09\xd2\x1c\xee\xfe" \
    "\x35\x1d\x1d\xd5\xcf\x14\x26\xb9\xcb\xea\xb6\x31\x34\x86\x0b\xaa" \
    "\x80\xc6\x23\x04\x1c\xd6\xc7\x16\x29\x01\x0a\xe0\x53\xe1\xa3\x02" \
    "\xde\xed\x80\xb4\x14\x47\x47\x57\x68\xc7\x3a\xf2\x10\x54\x4b\x1f" \
    "\x1e\x8e\x93\x9f\x0a\xc3\xd6\x1f\x95\xe1\x84\x6e\x70\xb6\xc2\xd4" \
    "\x6e\x39\xd0\x3b\xde\xd0\xd9\x8e\x34\x7a\x8c\x5e\xe9\x20\x2f\x7f" \
    "\x82\xff\x6b\xb2\xd0\x35\x7f\xd9\x24\xcf\x32\x64\x11\xf8\xce\xb4" \
    "\x4c\xd6\x25\xe6\x2e\xf7\xce\x10\x2f\x6a\xaa\x18\xe1\x8f\xd7\x0d" \
    "\xae\x0d\x2e\x50\x21\xaa\x27\x2d\x9c\xf7\x16\x56\xbc\x96\x3b\x7d" \
    "\x0c\x9d\x90\x3b\xb5\x07\xd6\xef\x35\x90\x37\x9f\x44\x28\x8e\x0a" \
    "\x93\xf2\x10\x4e\x64\xed\x1d\x24\x56\xbc\x41\xd7\x9c\xba\x91\xe8" \
    "\xaf\x8a\x63\x5f\x96\xff\x3b\x74\x91\x34\xa6\xbf\x45\x8d\x51\x5f" \
    "\xe9\xe2\x70\xc4\x0a\x4c\x94\x1e\xe7\xf4\x34\x44\x0b\x16\x64\x41" \
    "\xb9\xe8\xd3\x2d\xf8\x95\xba\xd9\x27\x72\xe8\xf8\x78\x44\x35\xf9" \
    "\xf1\x6c\x6b\xb5\x0f\x91\x5a\xdc\xb9\x8f\xfb\x0f\x4c\x58\x5c\x58" \
    "\x70\xaf\x94\xc1\xe2\xfb\x91\xa0\xb1\x56\x55\x4b\xb0\x61\xf3\xcc" \
    "\xdc\x7e\x35\x9b\x33\x99\x63\xd3\xa3\xf6\xe8\xa2\x53\xb9\xd6\x86" \
    "\xa5\x75\x1b\x3e\xe1\xe6\xd1\x3b\x3c\xd0\x07\x43\xf0\x66\x60\x10" \
    "\x28\x72\x63\x29\xef\xb0\xe6\x23\x60\xef\xf2\x19\x13\x79\x76\x57" \
    "\xcb\xc3\xad\x14\xfa\x5c\xc1\x14\x87\x8a\x32\x62\x5f\x4c\x78\x08" \
    "\xbf\x0c\x8b\x41\x56\xeb\x98\x08\xb6\xa2\xd2\x7e\x27\xfa\x67\xca" \
    "\x69\xb3\xcd\x2b\xaa\x81\xa4\x31\x57\xf0\x53\xc3\x23\xab\xa3\x46" \
    "\xd3\xfe\x2b\x52\xeb\x50\x80\x7f\xc4\xec\xc2\x22\x75\x49\xc6\x0e" \
    "\x32\xae\x56\x8b\xd3\xf2\x21\x8e\x8a\x67\x8f\x3b\xb0\x95\xe4\x93" \
    "\x86\xd8\x89\x4c\x04\x40\x7c\xaa\x1e\x77\x92\x7d\x39\x43\x18\x35" \
    "\x1d\x9d\x26\xd3\x8a\xc2\x7b\xc6\xed\x85\xa1\xf7\x37\xe0\xeb\x5f" \
    "\x70\x42\x5a\x0c\xcc\xdd\x3e\xf4\xea\xba\xe3\x0e\x47\xb8\xc5\x6b" \
    "\x17\xc8\x9d\x6b\x33\xe9\xae\x7d\xfd\x03\xc4\xc7\x13\x24\xb4\x51" \
    "\x2e\x25\xc7\x97\x27\x42\x62\x78\xd3\x79\x54\x16\x9b\x38\xf4\xcf" \
    "\xe1\x9f\x23\xb4\x50\x4e\xeb\x31\xa2\x9d\x4f\xf6\xf2\x59\x2b\xda" \
    "\xfb\x5f\x71\x23\x66\xeb\x85\xb8\x00\x77\x4a\xa7\xd8\xe7\x41\x8a" \
    "\x52\x56\xad\x34\xc4\x54\xd2\x19\x9e\xdd\x58\x04\x4d\x9d\xe3\x6d" \
    "\x8c\x22\xc4\xeb\x00\x47\x83\xe3\xb8\xe9\x01\x2a\xdc\xfe\x0e\xee" \
    "\x0d\xac\x6b\x6d\x56\x12\x59\xe2\xa5\x80\x05\x89\x12\xbc\x9c\xab" \
    "\x92\x1e\xe1\x6b\xc9\x50\xb9\x2c\x2d\x49\x9c\x54\x8a\x61\x13\x8f" \
    "\xaf\x1e\xfd\x7b\x90\x5d\xa1\xcb\x3a\x09\xe6\x9a\x7e\x11\x27\x13" \
    "\x47\x11\x61\xe2\x35\x73\x8a\x55\x85\x99\x29\xdc\x16\x3a\x08\x88" \
    "\x73\xda\x61\x16\x99\x48\x34\x8d\xf1\x5d\xb6\xe5\xc0\x00\xa3\x31" \
    "\x67\xd6\x0f\xe0\x63\x1c\x2c\x7a\x2e\x9d\x01\xf5\x2c\x4f\xb2\xfc" \
    "\xa3\x19\x1b\x14\xe5\x70\x44\x10\x78\x47\xa0\xa3\xcc\xa4\xaa\xb1" \
    "\xcf\x3d\x1d\x9d\xf9\xef\xdb\x5e\xdf\xd8\x62\x08\xa3\xf4\x55\x75" \
    "\x53\x93\xdf\xfa\x8a\x3f\xa8\x7e\xc8\xee\x59\xf4\x9f\xbc\xf2\x1f" \
    "\xed\x1c\x8d\x57\xf1\x97\x5f\x29\xb3\xc9\xf8\xcf\x41\xce\x9f\x1d" \
    "\x44\xce\x45\xdb\x75\xad\x30\xe0\x27\x9d\xb5\xc3\x19\x8f\x6f\x21" \
    "\x1f\x1a\x9b\x3a\x2a\x54\x6f\x8c\x1f\xfc\x45\x04\x7e\xa9\xea\x07" \
    "\xac\x2b\x09\xf3\xe6\xcf\xf0\xc8\x74\xec\x0d\xa9\xd5\xd3\x9c\x17" \
    "\xc0\x19\x37\x15\x11\xac\x92\x89\xe6\xd5\xca\x72\x4a\x2a\x85\xca" \
    "\x39\x3b\xfd\x1c\x3d\x76\xd1\x22\x42\x07\xa4\x40\x99\x25\xba\x2b" \
    "\x36\xe2\x2a\xea\x07\xc5\x15\x6c\x41\x8e\x33\x11\xc1\xaf\x96\x50" \
    "\x53\x79\xc4\x5f\x55\x5e\xda\x2b\xae\x01\xea\x56\x92\xe1\x8a\x9a" \
    "\xd0\x6f\x59\x0f\x76\x4a\x41\x3b\x64\xb7\x6f\x45\x72\xfd\x46\xed" \
    "\xa1\xcc\x1a\x62\x9a\x98\x8c\xb8\x05\x3e\xab\x76\x71\x58\x73\x9b" \
    "\xab\x1f\x80\x5c\xd9\x1e\x10\xa7\x23\xe0\x48\xf4\xc6\xe0\xb6\x4c" \
    "\xc1\x78\x53\x96\x37\x50\x64\x02\x50\x83\x8f\x16\x7e\x84\x97\x3f" \
    "\x5e\x16\xdc\xf0\x4b\x22\xce\xd6\x88\xf3\xb3\xf8\xc8\x45\xbd\x6a" \
    "\xa2\x0e\x60\x9b\xa0\xc2\xf4\xee\x6e\x04\x20\x7e\xe7\xdc\xf6\xaf" \
    "\x82\x87\x41\x0a\xda\x7d\xdb\x76\x03\xdf\xd7\x00\xcb\xa3\xb7\xbd" \
    "\x79\x93\x6b\xa1\x0b\xc8\x57\x9f\xae\xd0\x57\x42\x28\xdf\x6d\xcc" \
    "\x57\x27\x62\x37\x1a\x3f\xe6\x3e\x8f\xc0\x41\xb7\x91\x43\xcb\xbc" \
    "\x6c\x3f\x63\x0b\x86\xae\x2d\xc6\x1a\xe7\x6e\x2f\x2b\x1c\x68\xf8" \
    "\x7f\x2b\xde\xbb\x92\x45\xac\x03\x8b\x5f\x49\x08\x07\x6f\x3a\x58" \
    "\x9d\x8e\x04\x0f\x78\xad\x60\xa4\x8f\x47\xde\x5e\x31\xa0\xcd\xf0" \
    "\x63\x35\x5b\xc7\x47\x3e\x6d\x95\xc9\x4a\x2c\x4c\x6b\x1f\x4b\xcd" \
    "\xc3\xbd\x4f\x0a\x8b\x9d\x2d\x65\x94\x3c\x9d\xf5\x95\xe1\x6b\xf8" \
    "\x0b\x44\xe9\xf2\x17\xc2\xdd\xce\xe7\x24\x66\x78\x50\x8c\xd3\x09" \
    "\xb2\x63\x15\x09\x06\x03\xa6\xbd\xd5\xd5\x2b\x8d\x42\x2f\x58\xb5" \
    "\xfd\x5f\x7d\xab\x79\xd2\xd0\x5b\xcd\xac\xc6\x2a\x87\x66\x9a\x7f" \
    "\x75\x14\x0e\x55\x26\x78\xa5\xdd\xc0\xb1\x79\x78\x65\x2e\x87\x6e" \
    "\x11\xaf\x5a\x75\x6d\x4c\x9b\x55\xb2\x89\x73\xc8\xaa\x26\xf7\xe7" \
    "\x43\x10\x10\x5c\xd9\xa3\xef\xa2\x47\xad\x13\xdf\x73\x3f\x87\xa3" \
    "\x30\x36\xcc\x0a\x8c\x6c\xa3\xb7\xf7\xf4\xe9\xd7\x3a\xb3\x53\x24" \
    "\x15\x13\x47\x01\x48\x4c\x0e\xa2\x9b\x68\x41\x54\x7d\x0d\xe6\x5a" \
    "\x3f\x14\x65\x65\xfe\x97\xf4\xc0\xff\x3f\x81\x1b\x0f\x15\x08\x9f" \
    "\xb7\x8a\x44\x7c\xb1\xf4\x00\x47\x51\x08\x56\x26\xd2\x4c";

    struct ja3_struct *ja3; 
    int ret = get_ja3_struct_from_segment(payload, PL_LEN, &ja3);
    ck_assert_int_eq(ret, 0);
    ck_assert_str_eq(ja3->ja3str, EXP_JA3STR);
    ck_assert_str_eq(ja3->ja3hexstr, EXP_HEXSTR);

    /* Clean up */
    free_ja3_struct(ja3);
}
END_TEST

Suite *ja3_suite(void)
{
    Suite *s;
    TCase *tc_core;

    s = suite_create("JA3");
    tc_core = tcase_create("Core");

    tcase_add_test(tc_core, test_get_ja3_client_hello_seg_1);
    tcase_add_test(tc_core, test_get_ja3_client_hello_seg_2);
    tcase_add_test(tc_core, test_get_ja3_server_hello_seg_1);
    suite_add_tcase(s, tc_core);

    return s;
}

int main(void)
{
    int no_failed = 0;
    Suite *s;
    SRunner *runner;

    s = ja3_suite();
    runner = srunner_create(s);

    srunner_run_all(runner, CK_NORMAL);
    no_failed = srunner_ntests_failed(runner);
    srunner_free(runner);
    return (no_failed == 0) ? EXIT_SUCCESS : EXIT_FAILURE;
}